rules_version = '2';

/**
 * Firebase Storage Security Rules for Past Question Paper App
 * 
 * Security Model:
 * - Question images are read-only for all users
 * - Only server-side Admin SDK can upload/delete images
 * - User uploads are restricted by size and authentication
 * 
 * Last Updated: November 6, 2025
 */

service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check file size (in bytes)
    function isValidSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }
    
    // Check if file is an image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    // Admin email directory (lower-case)
    function adminEmailDirectory() {
      return {
        'irvinsenwedi@gmail.com': true,
        'irvinsenwedi25@gmail.com': true,
        'irvinsenwedi10@gmail.com': true,
        'admin@kinetix.com': true,
        'admin@kinetixes.com': true,
        'info@kinetix.com': true
      };
    }

    // Check if user is admin by custom claim or by allowed email
    function isAdmin() {
      return request.auth != null && (
        (request.auth.token.admin == true) ||
        (request.auth.token.email != null && adminEmailDirectory()[request.auth.token.email.lower()] == true)
      );
    }
    
    // ============================================
    // Question Images (Read-Only)
    // ============================================
    
    // Parent question images - public read, admin-only write
    match /parent_question_images/{fileName} {
      allow read: if true; // Anyone can read (needed for app to display images)
      // Allow writes from admin users from client (useful for admin portal uploads).
      // Also validate content type and size to prevent abuse.
      allow write: if isAdmin() && isImage() && isValidSize(10);
      allow delete: if isAdmin();
    }
    
    // Regular question images - public read, admin-only write
    match /question_images/{fileName} {
      allow read: if true; // Anyone can read (needed for app to display images)
      // Allow writes from admin users from client (admin portal) while ensuring file is an image
      allow write: if isAdmin() && isImage() && isValidSize(10);
      allow delete: if isAdmin();
    }

    // MCQ option images - public read, admin-only write
    match /mcq_option_images/{fileName} {
      allow read: if true;
      allow write: if isAdmin() && isImage() && isValidSize(10);
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Past Question Paper PDFs
    // ============================================
    
    // Past paper PDFs - public read, admin-only write
    match /papers/{fileName} {
      allow read: if true; // Anyone can read/download papers
      // Allow admin users to upload PDFs (max 10MB)
      allow write: if isAdmin() && 
                     request.resource.contentType == 'application/pdf' &&
                     isValidSize(10);
      allow delete: if isAdmin();
    }
    
    // ============================================
    // User Uploads (Future Feature)
    // ============================================
    
    // User profile pictures (if you add this feature later)
    match /user_uploads/{userId}/{fileName} {
      allow read: if true; // Public read
      
      // Users can upload their own files
      allow write: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     isImage() &&
                     isValidSize(5); // Max 5MB
      
      // Users can delete their own files
      allow delete: if isAuthenticated() && 
                      request.auth.uid == userId;
    }
    
    // User submitted answers (images for short answer/essay questions)
    match /user_submissions/{userId}/{sessionId}/{fileName} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      allow write: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     isImage() &&
                     isValidSize(10); // Max 10MB for submissions
      
      allow delete: if isAuthenticated() && 
                      request.auth.uid == userId;
    }
    
    // ============================================
    // Admin Uploads (Server-Side Only)
    // ============================================
    
    // Admin assets
    match /admin/{allPaths=**} {
      allow read: if true;
      // Allow admin users to upload administrative assets from client if they have admin claim
      allow write: if isAdmin() && isValidSize(20);
    }
    
    // ============================================
    // Default Deny All
    // ============================================
    
    // Deny access to everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
